(function(){
"use strict";
const TTL=1000*60*15,SEL=["[data-price]",".price","span.money"],PICK="__mlv_currency_picker_v2",KEY="mlv_currency_choice_v2";
function now(){return Date.now();}
function sset(k,v,ttl=TTL){try{localStorage.setItem(k,JSON.stringify({v:v,x:now()+ttl}));}catch(e){}}
function sget(k){try{const r=localStorage.getItem(k);if(!r)return null;const o=JSON.parse(r);if(!o||!o.x||now()>o.x){localStorage.removeItem(k);return null}return o.v}catch(e){return null}}
function detect(){try{const n=(navigator.languages&&navigator.languages[0])||navigator.language||"en-US";const lc=n.toLowerCase();if(lc.indexOf("en-gb")===0||lc.indexOf("-gb")>-1)return"GBP";if(lc.indexOf("en-in")===0||lc.indexOf("-in")>-1)return"INR";if(lc.indexOf("en-us")===0||lc.indexOf("-us")>-1)return"USD";if(lc.indexOf("jp")>-1)return"JPY";if(lc.indexOf("zh")>-1)return"CNY";if(lc.indexOf("au")>-1)return"AUD";return"USD"}catch(e){return"USD"}}
function parseNum(s){if(!s||typeof s!=="string")return null;const c=s.replace(/[^\d.,-]/g,"").trim();if(!c)return null;if(c.indexOf(".")>=0&&c.indexOf(",")>=0){const n=c.replace(/,/g,"");const v=parseFloat(n);return isNaN(v)?null:v;}if(c.indexOf(",")>=0&&c.indexOf(".")===-1){const n=c.replace(/\./g,"").replace(/,/g,".");const v=parseFloat(n);return isNaN(v)?null:v;}const n=c.replace(/,/g,"");const v=parseFloat(n);return isNaN(v)?null:v}
function fmt(v,cur){try{return new Intl.NumberFormat(undefined,{style:"currency",currency:cur,maximumFractionDigits:2}).format(v);}catch(e){return cur+" "+(Math.round(v*100)/100).toFixed(2)}}
function appOrigin(){try{if(window.__MLV_APP_ORIGIN__)return window.__MLV_APP_ORIGIN__;}catch(e){}return window.location.origin}
async function fetchRates(base,targets){try{const k=`rates_${base}_${(targets||[]).join(",")}`,c=sget(k);if(c)return c;const app=appOrigin();const qs=(targets&&targets.length)?`&symbols=${targets.join(",")}`:"";const r=await fetch(`${app}/api/rates?base=${encodeURIComponent(base)}${qs}`,{credentials:"omit"});if(!r.ok)return null;const j=await r.json();if(!j||!j.rates)return null;sset(k,j.rates);return j.rates}catch(e){return null}}
async function loadSettings(){try{const shop=(window.__MLV_SHOP__&&typeof window.__MLV_SHOP__==='string')?window.__MLV_SHOP__:window.location.hostname;const app=appOrigin();const url=`${app}/api/settings?shop=${encodeURIComponent(shop)}`;console.log("üîµ Fetching:",url);const r=await fetch(url,{credentials:"omit"});if(!r.ok){console.error("‚ùå Status:",r.status);return null;}const j=await r.json();console.log("‚úÖ Loaded:",j);return j}catch(e){console.error("‚ùå Error:",e);return null}}
function findNodes(){const s=new Set();for(const q of SEL){document.querySelectorAll(q).forEach(e=>s.add(e))}return Array.from(s)}
function convertEl(el,rate,cur){if(!el)return false;if(!el.dataset.orig)el.dataset.orig=el.textContent.trim();const n=parseNum(el.dataset.orig);if(n===null)return false;el.textContent=fmt(n*rate,cur);el.dataset.converted=cur;return true;}
function revertEl(el){if(!el)return;if(el.dataset&&el.dataset.orig){el.textContent=el.dataset.orig;try{delete el.dataset.converted;}catch(e){}}}
function injectCSS(){if(document.getElementById("__mlv_curr_css"))return;const css=`#${PICK}{position:fixed;z-index:2147483647;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}#${PICK} button{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer;min-width:60px}#${PICK} button::after{content:"‚ñæ";position:absolute;right:6px;top:50%;transform:translateY(-50%);pointer-events:none}[data-mlv-menu="true"]{position:absolute;min-width:120px;background:#fff;border:1px solid rgba(0,0,0,0.08);border-radius:8px;padding:6px;box-shadow:0 12px 30px rgba(0,0,0,0.08);display:none;max-height:300px;overflow:auto}[data-mlv-menu="true"] div{padding:6px 8px;cursor:pointer;border-radius:6px;font-size:13px}`;const s=document.createElement("style");s.id="__mlv_curr_css";s.appendChild(document.createTextNode(css));document.head.appendChild(s);}
function positionDrop(t,m){if(!t||!m)return;m.style.display="block";m.style.visibility="hidden";m.style.position="absolute";const trig=t.getBoundingClientRect();const mr=m.getBoundingClientRect();const vw=window.innerWidth,vh=window.innerHeight;let left=Math.max(8,trig.left+(trig.width-mr.width)/2);if(left+mr.width>vw)left=Math.max(8,vw-mr.width-8);if(vh-trig.bottom>mr.height+8){m.style.top=(trig.bottom+window.scrollY+8)+"px";m.style.left=(left+window.scrollX)+"px";}else{m.style.top=(Math.max(8,trig.top+window.scrollY-mr.height-8))+"px";m.style.left=(left+window.scrollX)+"px";}m.style.visibility="visible";m.style.zIndex="2147483647";}
function createPicker(settings,cur,onSelect){const prev=document.getElementById(PICK);if(prev)prev.remove();const wrap=document.createElement("div");wrap.id=PICK;const btn=document.createElement("button");btn.type="button";btn.innerText=cur||"Currency";btn.style.fontSize="13px";const menu=document.createElement("div");menu.setAttribute("data-mlv-menu","true");menu.style.display="none";const cand=(settings&&settings.selectedCurrencies&&settings.selectedCurrencies.length)?settings.selectedCurrencies:[cur||detect(),(settings&&settings.defaultCurrency)||"USD"];const uniq=Array.from(new Set(cand)).slice(0,8);uniq.forEach(code=>{const r=document.createElement("div");r.innerText=code;r.addEventListener("click",function(e){e.preventDefault();btn.innerText=code;menu.style.display="none";onSelect(code);});menu.appendChild(r);});document.addEventListener("click",function(ev){const curEl=document.getElementById(PICK);if(!curEl)return;const m=curEl.querySelector('[data-mlv-menu="true"]');if(!m)return;if(curEl.contains(ev.target))return;m.style.display="none";},{capture:true});btn.addEventListener("click",function(e){e.stopPropagation();try{if(menu.style.display==="block"){menu.style.display="none";}else{menu.style.display="block";positionDrop(btn,menu);}}catch(err){menu.style.display=menu.style.display==="none"?"block":"none";}});wrap.appendChild(btn);wrap.appendChild(menu);applyPlacement(wrap,settings);document.body.appendChild(wrap);return wrap;}
function applyPlacement(wrap,settings){if(!wrap)return;const placement=(settings&&settings.placement)||"Fixed Position";const fixedCorner=(settings&&settings.fixedCorner)||"bottom-left";const distanceTop=(settings&&settings.distanceTop!==undefined)?settings.distanceTop:16;const distanceRight=(settings&&settings.distanceRight!==undefined)?settings.distanceRight:16;const distanceBottom=(settings&&settings.distanceBottom!==undefined)?settings.distanceBottom:16;const distanceLeft=(settings&&settings.distanceLeft!==undefined)?settings.distanceLeft:16;if(placement==="Don't show at all"){wrap.style.display="none";return;}if(placement==="Inline with the header"){wrap.style.position="static";wrap.style.display="inline-block";return;}if(placement==="Fixed Position"){wrap.style.position="fixed";wrap.style.zIndex="2147483647";const corners={};if(fixedCorner.includes("top")){corners.top=distanceTop+"px";}else{corners.bottom=distanceBottom+"px";}if(fixedCorner.includes("left")){corners.left=distanceLeft+"px";}else{corners.right=distanceRight+"px";}Object.assign(wrap.style,corners);}}
if(!window.__mlv_global_handlers_installed){window.__mlv_global_handlers_installed=true;const hideAll=()=>{document.querySelectorAll('[data-mlv-menu="true"]').forEach(m=>{if(m.style.display==="block")m.style.display="none";});};window.addEventListener("scroll",hideAll,{passive:true});window.addEventListener("wheel",hideAll,{passive:true});window.addEventListener("touchstart",hideAll,{passive:true});window.addEventListener("keydown",(e)=>{if(e.key==="Escape")hideAll();});}
async function runFor(chosen,settings){if(!chosen)return;const base=(settings&&settings.baseCurrency)||"USD";if(base===chosen){findNodes().forEach(revertEl);return;}const rates=await fetchRates(base,[chosen]);if(!rates||!rates[chosen])return;const rate=rates[chosen];findNodes().forEach(el=>convertEl(el,rate,chosen));}
async function init(){try{console.log("üîµ Init");injectCSS();const settings=await loadSettings();const visitor=detect();const def=(settings&&settings.defaultCurrency)||visitor;const rem=localStorage.getItem(KEY)||null;const initial=rem||def||visitor;const picker=createPicker(settings||{},initial,async function(chosen){try{localStorage.setItem(KEY,chosen);await runFor(chosen,settings);}catch(e){console.error("Error:",e);}});await runFor(initial,settings);console.log("‚úÖ Ready");}catch(e){console.error("‚ùå Error:",e);}}
if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",init);else setTimeout(init,10);
})();